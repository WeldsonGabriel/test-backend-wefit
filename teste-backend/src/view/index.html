<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulário de Cadastro</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Cadastro</h1>
    <form id="form">
      <div id="error-message" class="error-message"></div>

      <!-- Tipo de Pessoa -->
      <div class="form-group">
        <label>Tipo de pessoa</label>
        <div class="radio-group">
          <input type="radio" name="tipoPessoa" id="fisica" value="fisica">
          <label for="fisica">Pessoa Física</label>
          <input type="radio" name="tipoPessoa" id="juridica" value="juridica">
          <label for="juridica">Pessoa Jurídica</label>
        </div>
      </div>

      <!-- Nome -->
      <div class="form-group">
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" placeholder="Digite o nome">
      </div>

      <!-- Email -->
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="Digite o email">
      </div>
      <div class="form-group">
        <label for="confirmarEmail">Confirmar Email</label>
        <input type="email" id="confirmarEmail" name="confirmarEmail" placeholder="Confirme o email">
      </div>

      <!-- CPF -->
      <div class="form-group" id="cpf-group" style="display: none;">
        <label for="cpf">CPF</label>
        <input type="text" id="cpf" name="cpf" placeholder="Digite o CPF">
      </div>

      <!-- CNPJ -->
      <div class="form-group" id="cnpj-group" style="display: none;">
        <label for="cnpj">CNPJ</label>
        <input type="text" id="cnpj" name="cnpj" placeholder="Digite o CNPJ">
      </div>

      <!-- Responsible CPF -->
      <div class="form-group" id="responsible-cpf-group" style="display: none;">
        <label for="responsibleCpf">CPF do Responsável</label>
        <input type="text" id="responsibleCpf" name="responsibleCpf" placeholder="Digite o CPF do responsável">
      </div>

      <!-- Endereço -->
      <div class="form-group">
        <label for="street">Rua</label>
        <input type="text" id="street" name="street" placeholder="Digite a rua">
      </div>
      <div class="form-group">
        <label for="number">Número</label>
        <input type="text" id="number" name="number" placeholder="Digite o número">
      </div>
      <div class="form-group">
        <label for="complement">Complemento</label>
        <input type="text" id="complement" name="complement" placeholder="Digite o complemento">
      </div>
      <div class="form-group">
        <label for="neighborhood">Bairro</label>
        <input type="text" id="neighborhood" name="neighborhood" placeholder="Digite o bairro">
      </div>
      <div class="form-group">
        <label for="city">Cidade</label>
        <input type="text" id="city" name="city" placeholder="Digite a cidade">
      </div>
      <div class="form-group">
        <label for="state">Estado</label>
        <input type="text" id="state" name="state" placeholder="Digite o estado">
      </div>
      <div class="form-group">
        <label for="postalCode">CEP</label>
        <input type="text" id="postalCode" name="postalCode" placeholder="Digite o CEP">
      </div>

      <!-- Termos -->
      <div class="form-group terms">
        <input type="checkbox" id="termos" name="termos">
        <label for="termos">Concordo com os termos de uso</label>
      </div>

      <button type="submit">Cadastrar</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="script.js"></script>
  <script>
    const API_URL = 'http://localhost:3000/api/cadastro'; // URL da API

    async function checkServerStatus() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) {
          throw new Error('Server not reachable');
        }
      } catch (error) {
        document.getElementById('error-message').innerText = 'Erro: Não foi possível acessar o servidor na porta 3000.';
      }
    }

    checkServerStatus();

    document.querySelectorAll('input[name="tipoPessoa"]').forEach((input) => {
      input.addEventListener('change', function () {
        if (this.value === 'fisica') {
          document.getElementById('cpf-group').style.display = 'block';
          document.getElementById('cnpj-group').style.display = 'none';
          document.getElementById('responsible-cpf-group').style.display = 'none';
        } else if (this.value === 'juridica') {
          document.getElementById('cpf-group').style.display = 'none';
          document.getElementById('cnpj-group').style.display = 'block';
          document.getElementById('responsible-cpf-group').style.display = 'block';
        }
      });
    });

    // Initialize form with "Pessoa Física" selected
    document.getElementById('fisica').checked = true;
    document.getElementById('cpf-group').style.display = 'block';
    document.getElementById('cnpj-group').style.display = 'none';
    document.getElementById('responsible-cpf-group').style.display = 'none';

    document.getElementById('postalCode').addEventListener('blur', async function () {
      const cep = this.value.replace(/\D/g, '');
      if (cep.length === 8) {
        try {
          const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
          if (response.ok) {
            const data = await response.json();
            if (!data.erro) {
              document.getElementById('street').value = data.logradouro;
              document.getElementById('neighborhood').value = data.bairro;
              document.getElementById('city').value = data.localidade;
              document.getElementById('state').value = data.uf;
            } else {
              alert('CEP não encontrado.');
            }
          } else {
            alert('Erro ao buscar CEP.');
          }
        } catch (error) {
          alert('Erro ao conectar com o servidor de CEP.');
        }
      } else {
        alert('CEP inválido.');
      }
    });

    function applyMask(input, maskFunction) {
      input.addEventListener('input', function () {
        this.value = maskFunction(this.value);
      });
    }

    function cpfMask(value) {
      return value
        .replace(/\D/g, '')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }

    function cnpjMask(value) {
      return value
        .replace(/\D/g, '')
        .replace(/(\d{2})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d)/, '$1/$2')
        .replace(/(\d{4})(\d{1,2})$/, '$1-$2');
    }

    applyMask(document.getElementById('cpf'), cpfMask);
    applyMask(document.getElementById('cnpj'), cnpjMask);
    applyMask(document.getElementById('responsibleCpf'), cpfMask);

    // Convert input values to uppercase except for email fields
    document.querySelectorAll('input[type="text"]').forEach((input) => {
      if (input.id !== 'email' && input.id !== 'confirmarEmail') {
        input.addEventListener('input', function () {
          this.value = this.value.toUpperCase();
        });
      }
    });

    // Handle form submission
    document.getElementById('form').addEventListener('submit', async function (event) {
      event.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      // Log the JSON being sent
      console.log('Sending data:', JSON.stringify(data));

      // Basic validation
      if (!data.nome || !data.email || !data.confirmarEmail) {
        document.getElementById('error-message').innerText = 'Por favor, preencha todos os campos obrigatórios.';
        return;
      }

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Erro ao enviar o formulário');
        }

        alert('Formulário enviado com sucesso!');
      } catch (error) {
        console.error('Erro ao enviar o formulário:', error);
        document.getElementById('error-message').innerText = 'Erro ao enviar o formulário. Tente novamente mais tarde.';
      }
    });
  </script>
</body>
</html>
